<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QMK Keymap Editor - Final Fixed</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 2em;
            background: linear-gradient(90deg, #00d4ff, #00ff88);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .panel-title {
            font-size: 1.1em;
            margin-bottom: 15px;
            color: #00d4ff;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        /* „Çø„Éñ„Çπ„Çø„Ç§„É´ */
        .tab-buttons {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        .tab-btn {
            padding: 10px 20px;
            background: transparent;
            border: none;
            color: #aaa;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
        }

        .tab-btn:hover {
            color: #00d4ff;
        }

        .tab-btn.active {
            color: #00d4ff;
            border-bottom-color: #00d4ff;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* „Éï„Ç°„Ç§„É´ÂÖ•Âäõ */
        .file-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .file-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .file-group label {
            font-size: 0.9em;
            color: #aaa;
        }

        .file-group input[type="file"] {
            background: rgba(0, 0, 0, 0.3);
            border: 2px dashed rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 15px;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s;
        }

        .status {
            font-size: 0.85em;
            padding: 5px 10px;
            border-radius: 4px;
            margin-top: 5px;
        }

        .status.success { background: rgba(0, 255, 136, 0.2); color: #00ff88; }
        .status.error { background: rgba(255, 68, 68, 0.2); color: #ff4444; }

        /* „Ç´„É©„Éº„Éî„ÉÉ„Ç´„Éº */
        .color-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .color-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .color-input-wrapper {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .color-input-wrapper input[type="color"] {
            width: 60px;
            height: 40px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        .color-input-wrapper input[type="text"] {
            flex: 1;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            padding: 8px 12px;
            color: #fff;
            font-family: monospace;
        }

        /* „É¨„Ç§„É§„Éº„Çø„Éñ */
        .layer-tabs {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .layer-tab {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .layer-tab.active {
            background: linear-gradient(135deg, #00d4ff, #00ff88);
            color: #000;
            font-weight: bold;
        }

        .layer-tab .delete-layer {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: rgba(255, 0, 0, 0.5);
            border: none;
            color: #fff;
            cursor: pointer;
            font-size: 12px;
            line-height: 1;
            opacity: 0.7;
        }

        .add-layer-btn {
            padding: 10px 20px;
            background: rgba(0, 212, 255, 0.2);
            border: 2px dashed #00d4ff;
            border-radius: 8px;
            color: #00d4ff;
            cursor: pointer;
        }

        /* „Ç≠„Éº„Éú„Éº„ÉâË°®Á§∫ */
        .keyboard-wrapper {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 40px;
            min-height: 300px;
            overflow: auto;
        }

        .keyboard-container {
            position: relative;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 20px;
        }

        .key {
            position: absolute;
            background: linear-gradient(145deg, #3a3a4a, #2a2a3a);
            border: 2px solid #444;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.1s;
            padding: 4px;
            word-break: break-all;
            overflow: hidden;
            text-overflow: ellipsis;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .key:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 212, 255, 0.3);
            border-color: #00d4ff;
        }

        .key.selected {
            border-color: #00ff88 !important;
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.8), inset 0 0 10px rgba(0, 255, 136, 0.2) !important;
            z-index: 100;
            transform: translateY(-2px);
        }

        .key.encoder {
            border-radius: 50%;
        }

        .encoder-side-box {
            position: absolute;
            background: linear-gradient(145deg, #3a3a4a, #2a2a3a);
            border: 2px solid #ff8800;
            border-radius: 6px;
            display: none;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
            padding: 4px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.1);
            z-index: 150;
        }

        .encoder-side-box.visible {
            display: flex;
            animation: fadeIn 0.2s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .encoder-side-box.selected {
            border-color: #00ff88 !important;
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.8) !important;
        }

        /* „Ç®„Éá„Ç£„Çø„Éº„Éë„Éç„É´ (1:1ÊØîÁéá) */
        .editor-panel {
            display: none;
            grid-template-columns: 1fr 1fr; /* „Åì„Åì„Çí1fr 1fr„Å´Á∂≠ÊåÅ */
            gap: 20px;
        }

        .editor-panel.visible {
            display: grid;
        }

        .key-info {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .info-tab-content {
            display: none;
            flex: 1;
            overflow-y: auto;
        }

        .info-tab-content.active {
            display: block;
        }

        .key-input-group {
            margin-bottom: 15px;
        }

        .key-input-group label {
            display: block;
            margin-bottom: 5px;
            color: #aaa;
            font-size: 0.9em;
        }

        .key-input-group input {
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            padding: 8px 12px;
            color: #fff;
            font-family: monospace;
        }

        /* „Ç´„ÉÜ„Ç¥„É™„Éº„Éú„Çø„É≥ */
        .keycode-categories {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .category-btn {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 6px;
            color: #aaa;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9em;
        }

        .category-btn.active {
            background: linear-gradient(135deg, #00d4ff, #00ff88);
            color: #000;
            font-weight: bold;
        }

        .keycode-quick {
            display: none;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 8px;
            max-height: 300px;
            overflow-y: auto;
        }

        .keycode-quick.visible {
            display: grid;
        }

        .keycode-quick#encoderKeycodes {
            display: none;
        }

        .keycode-quick#encoderKeycodes.visible {
            display: block;
        }

        .keycode-btn {
            padding: 8px;
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 6px;
            color: #00d4ff;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.2s;
        }

        .keycode-btn:hover {
            background: rgba(0, 212, 255, 0.2);
        }

        /* „Éú„Çø„É≥ */
        .btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #00d4ff, #00ff88);
            border: none;
            border-radius: 8px;
            color: #000;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 212, 255, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .btn-danger {
            background: rgba(255, 68, 68, 0.3);
            color: #ff4444;
        }

        .actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* „É°„É¢„Ç¢„Ç§„ÉÜ„É† */
        .note-item {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid rgba(255,255,255,0.05);
        }

        .note-item input {
            width: 100%;
            margin-bottom: 5px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            padding: 6px 8px;
            color: #fff;
            font-size: 0.9em;
        }

        .note-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .delete-note {
            background: rgba(255, 68, 68, 0.2);
            border: 1px solid rgba(255, 68, 68, 0.3);
            color: #ff4444;
            width: 24px;
            height: 24px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .delete-note:hover {
            background: rgba(255, 68, 68, 0.4);
        }

        /* GistË®≠ÂÆö */
        .gist-settings {
            display: grid;
            gap: 10px;
        }

        .gist-input {
            display: flex;
            gap: 10px;
        }

        .gist-input input {
            flex: 1;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            padding: 8px 12px;
            color: #fff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéπ QMK Keymap Editor</h1>

        <div class="panel">
            <div class="panel-title">
                <div>üìÇ „É¨„Ç§„É§„ÉºÁÆ°ÁêÜ</div>
                <div style="font-size: 0.9em; color: #888;">
                    ÁèæÂú®„ÅÆ„É¨„Ç§„É§„ÉºÊï∞: <span id="layerCount" style="color: #00d4ff; font-weight: bold; font-size: 1.1em; margin-left: 5px;">0</span>
                </div>
            </div>
            <div class="layer-tabs" id="layerTabs">
                <button class="add-layer-btn" onclick="addLayer()">+ „É¨„Ç§„É§„ÉºËøΩÂä†</button>
            </div>
        </div>

        <div class="panel">
            <div class="panel-title">‚å®Ô∏è „Ç≠„Éº„Éú„Éº„Éâ„É¨„Ç§„Ç¢„Ç¶„Éà</div>
            <div class="keyboard-wrapper">
                <div class="keyboard-container" id="keyboardContainer">
                    <div style="color: #888; text-align: center;">JSON„Éï„Ç°„Ç§„É´„ÇíË™≠„ÅøËæº„Çì„Åß„Åè„Å†„Åï„ÅÑ</div>
                </div>
            </div>
        </div>

        <div class="panel editor-panel" id="editorPanel">
            <div class="key-info">
                <h3>üîß „Ç≠„ÉºË®≠ÂÆö <span id="selectedKeyId" style="font-size: 0.9em; color: #aaa;"></span></h3>
                <div class="key-input-group">
                    <label>„Ç≠„Éº„Ç≥„Éº„Éâ:</label>
                    <input type="text" id="keycodeInput" placeholder="KC_A" oninput="updateKeycode(this.value)">
                </div>
                <div class="key-input-group">
                    <label>„Ç´„ÉÜ„Ç¥„É™„ÉºÈÅ∏Êäû:</label>
                    <div class="keycode-categories">
                        <button class="category-btn active" onclick="showCategory('basic')">Âü∫Êú¨</button>
                        <button class="category-btn" onclick="showCategory('mod')">‰øÆÈ£æ</button>
                        <button class="category-btn" onclick="showCategory('layer')">„É¨„Ç§„É§„Éº</button>
                        <button class="category-btn" onclick="showCategory('media')">„É°„Éá„Ç£„Ç¢</button>
                        <button class="category-btn" onclick="showCategory('mouse')">„Éû„Ç¶„Çπ</button>
                        <button class="category-btn" onclick="showCategory('special')">ÁâπÊÆä</button>
                        <button class="category-btn" onclick="showCategory('encoder')">„Ç®„É≥„Ç≥„Éº„ÉÄ„Éº</button>
                    </div>
                    <div class="keycode-quick visible" id="basicKeycodes">
                        <button class="keycode-btn" data-kc="KC_A">A</button>
                        <button class="keycode-btn" data-kc="KC_B">B</button>
                        <button class="keycode-btn" data-kc="KC_C">C</button>
                        <button class="keycode-btn" data-kc="KC_D">D</button>
                        <button class="keycode-btn" data-kc="KC_E">E</button>
                        <button class="keycode-btn" data-kc="KC_F">F</button>
                        <button class="keycode-btn" data-kc="KC_G">G</button>
                        <button class="keycode-btn" data-kc="KC_H">H</button>
                        <button class="keycode-btn" data-kc="KC_I">I</button>
                        <button class="keycode-btn" data-kc="KC_J">J</button>
                        <button class="keycode-btn" data-kc="KC_K">K</button>
                        <button class="keycode-btn" data-kc="KC_L">L</button>
                        <button class="keycode-btn" data-kc="KC_M">M</button>
                        <button class="keycode-btn" data-kc="KC_N">N</button>
                        <button class="keycode-btn" data-kc="KC_O">O</button>
                        <button class="keycode-btn" data-kc="KC_P">P</button>
                        <button class="keycode-btn" data-kc="KC_Q">Q</button>
                        <button class="keycode-btn" data-kc="KC_R">R</button>
                        <button class="keycode-btn" data-kc="KC_S">S</button>
                        <button class="keycode-btn" data-kc="KC_T">T</button>
                        <button class="keycode-btn" data-kc="KC_U">U</button>
                        <button class="keycode-btn" data-kc="KC_V">V</button>
                        <button class="keycode-btn" data-kc="KC_W">W</button>
                        <button class="keycode-btn" data-kc="KC_X">X</button>
                        <button class="keycode-btn" data-kc="KC_Y">Y</button>
                        <button class="keycode-btn" data-kc="KC_Z">Z</button>
                        <button class="keycode-btn" data-kc="KC_1">1</button>
                        <button class="keycode-btn" data-kc="KC_2">2</button>
                        <button class="keycode-btn" data-kc="KC_3">3</button>
                        <button class="keycode-btn" data-kc="KC_4">4</button>
                        <button class="keycode-btn" data-kc="KC_5">5</button>
                        <button class="keycode-btn" data-kc="KC_6">6</button>
                        <button class="keycode-btn" data-kc="KC_7">7</button>
                        <button class="keycode-btn" data-kc="KC_8">8</button>
                        <button class="keycode-btn" data-kc="KC_9">9</button>
                        <button class="keycode-btn" data-kc="KC_0">0</button>
                        <button class="keycode-btn" data-kc="KC_ENT">Enter</button>
                        <button class="keycode-btn" data-kc="KC_ESC">Esc</button>
                        <button class="keycode-btn" data-kc="KC_BSPC">BkSp</button>
                        <button class="keycode-btn" data-kc="KC_TAB">Tab</button>
                        <button class="keycode-btn" data-kc="KC_SPC">Space</button>
                        <button class="keycode-btn" data-kc="KC_MINS">-</button>
                        <button class="keycode-btn" data-kc="KC_EQL">=</button>
                        <button class="keycode-btn" data-kc="KC_LBRC">[</button>
                        <button class="keycode-btn" data-kc="KC_RBRC">]</button>
                        <button class="keycode-btn" data-kc="KC_BSLS">\</button>
                        <button class="keycode-btn" data-kc="KC_SCLN">;</button>
                        <button class="keycode-btn" data-kc="KC_QUOT">'</button>
                        <button class="keycode-btn" data-kc="KC_GRV">`</button>
                        <button class="keycode-btn" data-kc="KC_COMM">,</button>
                        <button class="keycode-btn" data-kc="KC_DOT">.</button>
                        <button class="keycode-btn" data-kc="KC_SLSH">/</button>
                    </div>
                    <div class="keycode-quick" id="modKeycodes">
                         <button class="keycode-btn" data-kc="KC_LSFT">L Shift</button>
                         <button class="keycode-btn" data-kc="KC_RSFT">R Shift</button>
                         <button class="keycode-btn" data-kc="KC_LCTL">L Ctrl</button>
                         <button class="keycode-btn" data-kc="KC_RCTL">R Ctrl</button>
                         <button class="keycode-btn" data-kc="KC_LALT">L Alt</button>
                         <button class="keycode-btn" data-kc="KC_RALT">R Alt</button>
                         <button class="keycode-btn" data-kc="KC_LGUI">L GUI</button>
                         <button class="keycode-btn" data-kc="KC_RGUI">R GUI</button>
                    </div>
                    <div class="keycode-quick" id="layerKeycodes">
                        <button class="keycode-btn" data-kc="MO(1)">MO(1)</button>
                        <button class="keycode-btn" data-kc="MO(2)">MO(2)</button>
                        <button class="keycode-btn" data-kc="TG(1)">TG(1)</button>
                        <button class="keycode-btn" data-kc="TG(2)">TG(2)</button>
                        <button class="keycode-btn" data-kc="TO(0)">TO(0)</button>
                        <button class="keycode-btn" data-kc="KC_TRNS">‚ñΩ TRNS</button>
                        <button class="keycode-btn" data-kc="KC_NO">‚úï NO</button>
                    </div>
                    <div class="keycode-quick" id="mediaKeycodes">
                        <button class="keycode-btn" data-kc="KC_MUTE">Mute</button>
                        <button class="keycode-btn" data-kc="KC_VOLU">Vol+</button>
                        <button class="keycode-btn" data-kc="KC_VOLD">Vol-</button>
                    </div>
                    <div class="keycode-quick" id="mouseKeycodes">
                        <button class="keycode-btn" data-kc="KC_MS_U">M Up</button>
                        <button class="keycode-btn" data-kc="KC_MS_D">M Down</button>
                        <button class="keycode-btn" data-kc="KC_BTN1">Btn1</button>
                        <button class="keycode-btn" data-kc="KC_BTN2">Btn2</button>
                    </div>
                    <div class="keycode-quick" id="specialKeycodes">
                        <button class="keycode-btn" data-kc="QK_BOOT">BOOT</button>
                        <button class="keycode-btn" data-kc="QK_RBT">REBOOT</button>
                    </div>
                    <div class="keycode-quick" id="encoderKeycodes">
                        <div style="margin-bottom: 15px; padding: 15px; background: rgba(0, 212, 255, 0.1); border-radius: 8px;">
                            <div style="font-size: 0.95em; margin-bottom: 10px; color: #00d4ff;">
                                <strong>„Ç®„É≥„Ç≥„Éº„ÉÄ„ÉºË®≠ÂÆö</strong>
                            </div>
                            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                                <button class="btn" onclick="setAsEncoder()" style="flex: 1;">üéõÔ∏è Ë®≠ÂÆö</button>
                                <button class="btn btn-danger" onclick="removeEncoder()" style="flex: 1;">‚ùå Ëß£Èô§</button>
                            </div>
                            <div id="encoderInputs" style="display: none; margin-top: 15px;">
                                <div style="margin-bottom: 10px;">
                                    <label style="font-size: 0.85em; color: #aaa;">Â∑¶ÂõûËª¢ (CCW)</label>
                                    <input type="text" id="encoderCcwInput" onchange="updateEncoderKeycode('ccw', this.value)" onfocus="selectKey(selectedKey, 'ccw')">
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <label style="font-size: 0.85em; color: #aaa;">„Éó„ÉÉ„Ç∑„É• (Push)</label>
                                    <input type="text" id="encoderPushInput" onchange="updateEncoderKeycode('push', this.value)" onfocus="selectKey(selectedKey, 'push')">
                                </div>
                                <div>
                                    <label style="font-size: 0.85em; color: #aaa;">Âè≥ÂõûËª¢ (CW)</label>
                                    <input type="text" id="encoderCwInput" onchange="updateEncoderKeycode('cw', this.value)" onfocus="selectKey(selectedKey, 'cw')">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="key-input-group">
                    <label>„Ç≠„ÉºÂÄãÂà•„Ç´„É©„Éº:</label>
                    <div class="color-grid">
                        <div class="color-group">
                            <label>ËÉåÊôØËâ≤</label>
                            <div class="color-input-wrapper">
                                <input type="color" id="keyIndividualBg" onchange="updateIndividualKeyColor()">
                                <input type="text" id="keyIndividualBgText" onchange="updateIndividualKeyColorFromText('bg')">
                            </div>
                        </div>
                        <div class="color-group">
                            <label>„ÉÜ„Ç≠„Çπ„ÉàËâ≤</label>
                            <div class="color-input-wrapper">
                                <input type="color" id="keyIndividualText" onchange="updateIndividualKeyColor()">
                                <input type="text" id="keyIndividualTextText" onchange="updateIndividualKeyColorFromText('text')">
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-secondary" style="margin-top: 10px;" onclick="resetIndividualKeyColor()">ÂÄãÂà•Ëâ≤„Çí„É™„Çª„ÉÉ„Éà</button>
                </div>
            </div>

            <div class="key-info">
                <div style="display: flex; gap: 10px; margin-bottom: 15px; border-bottom: 2px solid rgba(255,255,255,0.1);">
                    <button class="tab-btn active" onclick="switchInfoTab('keyInfo')" style="margin-bottom: -2px;">‚ÑπÔ∏è ÊÉÖÂ†±</button>
                    <button class="tab-btn" onclick="switchInfoTab('notes')" style="margin-bottom: -2px;">üìù „É°„É¢</button>
                </div>
                
                <div id="keyInfoTab" class="info-tab-content active">
                    <div id="keyInfoDisplay" style="font-size: 0.9em; color: #aaa;">„Ç≠„Éº„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
                </div>
                
                <div id="notesTab" class="info-tab-content">
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h4 style="color: #00d4ff; margin: 0;">‚ö° Tap Dance</h4>
                            <button class="btn btn-secondary" style="padding: 2px 10px; font-size: 0.8em;" onclick="addNote('tapDance')">+</button>
                        </div>
                        <div id="tapDanceNotes"></div>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h4 style="color: #00d4ff; margin: 0;">üîó Combo</h4>
                            <button class="btn btn-secondary" style="padding: 2px 10px; font-size: 0.8em;" onclick="addNote('combo')">+</button>
                        </div>
                        <div id="comboNotes"></div>
                    </div>
                    <div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h4 style="color: #00d4ff; margin: 0;">üìå Macro</h4>
                            <button class="btn btn-secondary" style="padding: 2px 10px; font-size: 0.8em;" onclick="addNote('macro')">+</button>
                        </div>
                        <div id="macroNotes"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="panel tab-container">
            <div class="tab-buttons">
                <button class="tab-btn active" onclick="switchTab('globalColor')">ÂÖ®‰Ωì„Ç´„É©„Éº</button>
                <button class="tab-btn" onclick="switchTab('fileLoad')">„Éï„Ç°„Ç§„É´Ë™≠Ëæº</button>
                <button class="tab-btn" onclick="switchTab('save')">‰øùÂ≠ò/Ë™≠Ëæº</button>
            </div>

            <div class="tab-content active" id="globalColorTab">
                <div class="panel-title">üé® „Ç≠„ÉºÂÖ®‰Ωì„Ç´„É©„ÉºË®≠ÂÆö</div>
                <div class="color-grid">
                    <div class="color-group">
                        <label>ËÉåÊôØËâ≤</label>
                        <div class="color-input-wrapper">
                            <input type="color" id="keyBgColor" value="#3a3a4a" onchange="updateKeyColors()">
                            <input type="text" id="keyBgColorText" value="#3a3a4a" onchange="updateKeyColorsFromText('bg')">
                        </div>
                    </div>
                    <div class="color-group">
                        <label>„ÉÜ„Ç≠„Çπ„ÉàËâ≤</label>
                        <div class="color-input-wrapper">
                            <input type="color" id="keyTextColor" value="#ffffff" onchange="updateKeyColors()">
                            <input type="text" id="keyTextColorText" value="#ffffff" onchange="updateKeyColorsFromText('text')">
                        </div>
                    </div>
                    <div class="color-group">
                        <label>„Ç≠„Éº„Éú„Éº„ÉâÊã°Â§ßÁéá (%)</label>
                        <input type="range" id="keyboardScale" min="50" max="250" value="100" style="width:100%" oninput="updateKeyboardScale(this.value)">
                    </div>
                </div>
                <button class="btn btn-secondary" style="margin-top: 15px;" onclick="resetKeyColors()">„Éá„Éï„Ç©„É´„Éà„Å´Êàª„Åô</button>
            </div>

            <div class="tab-content" id="fileLoadTab">
                <div class="panel-title">üìÅ „Éï„Ç°„Ç§„É´Ë™≠Ëæº</div>
                <div class="file-inputs">
                    <div class="file-group">
                        <label>keyboard.json</label>
                        <input type="file" id="keyboardJsonFile" accept=".json" onchange="loadKeyboardJson(event)">
                        <div class="status" id="keyboardJsonStatus"></div>
                    </div>
                    <div class="file-group">
                        <label>keymap.c</label>
                        <input type="file" id="keymapCFile" accept=".c" onchange="loadKeymapC(event)">
                        <div class="status" id="keymapCStatus"></div>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="saveTab">
                <div class="panel-title">üíæ ‰øùÂ≠ò / Ë™≠Ëæº</div>
                <div style="margin-bottom: 20px;">
                    <h4 style="color: #00d4ff; margin-bottom: 10px;">GitHub Gist ÈÄ£Êê∫ (URLÂÖ±ÊúâÊ©üËÉΩ‰ªò„Åç)</h4>
                    <div class="gist-settings">
                        <div class="gist-input">
                            <input type="password" id="gistToken" placeholder="Personal Access Token (‰øùÂ≠òÊôÇ„Å´ÂøÖÈ†à)" value="" onchange="saveGistToken()">
                        </div>
                        <div class="gist-input">
                            <input type="text" id="gistId" placeholder="Gist ID (Ë™≠„ÅøËæº„ÅøÊôÇ„ÅØ„Åì„Åì„Å´ÂÖ•Âäõ)" >
                            <button class="btn btn-secondary" onclick="shareUrl()">üîó ÂÖ±ÊúâÁî®URL„Ç≥„Éî„Éº</button>
                        </div>
                        <div style="font-size: 0.85em; color: #888; margin-top: 5px;">
                            ‚Äª GitHub„É≠„Ç∞„Ç§„É≥Ê©üËÉΩ„ÅØ„Çµ„Éº„Éê„Éº„ÅåÂøÖË¶Å„Å™„Åü„ÇÅ„ÄÅÂçò‰∏ÄHTML„Åß„ÅØÂÆüË£Ö„Åß„Åç„Åæ„Åõ„Çì„ÄÇ<br>
                            ‰ª£„Çè„Çä„Å´„ÄåÂÖ±ÊúâÁî®URL„Äç„Çí‰Ωø„ÅÜ„Å®„ÄÅIDÂÖ•Âäõ‰∏çË¶Å„ÅßÈñã„Åë„Åæ„Åô„ÄÇ‰øùÂ≠ò„Å´„ÅØ„Éà„Éº„ÇØ„É≥„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ
                        </div>
                    </div>
                    <div class="actions" style="margin-top: 10px;">
                        <button class="btn" onclick="saveToGist()">‚òÅÔ∏è Gist„Å´‰øùÂ≠ò</button>
                        <button class="btn btn-secondary" onclick="loadFromGist()">‚òÅÔ∏è Gist„Åã„ÇâË™≠Ëæº</button>
                    </div>
                </div>
                <hr style="border: none; border-top: 1px solid rgba(255,255,255,0.1); margin: 20px 0;">
                <div>
                    <h4 style="color: #00d4ff; margin-bottom: 10px;">„Ç≠„Éº„Éû„ÉÉ„ÉóÁîüÊàê</h4>
                    <div class="actions">
                        <button class="btn" onclick="downloadKeymap()">üìÑ keymap.c „ÉÄ„Ç¶„É≥„É≠„Éº„Éâ</button>
                        <button class="btn" onclick="saveToLocal()">üíæ „Éñ„É©„Ç¶„Ç∂‰øùÂ≠ò</button>
                        <button class="btn btn-secondary" onclick="loadFromLocal()">üìÇ „Éñ„É©„Ç¶„Ç∂Ë™≠Ëæº</button>
                        <button class="btn btn-danger" onclick="clearAll()">üóëÔ∏è ÂÖ®„ÇØ„É™„Ç¢</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== GLOBAL STATE ====================
        let layoutData = null;
        let layoutName = '';
        let layers = [];
        let currentLayer = 0;
        let selectedKey = null;
        let selectedEncoderSide = null;
        let keyColors = { bg: '#3a3a4a', text: '#ffffff', border: '#444444' };
        let individualKeyColors = {}; 
        let encoderKeys = {}; 
        let notes = { tapDance: [], combo: [], macro: [] };
        let nextNoteId = { tapDance: 1, combo: 1, macro: 1 };
        let keyboardScalePercent = 100;
        let keyFontSize = 11;
        let keyFont = "'Segoe UI', sans-serif";
        const MAX_LAYERS = 16;
        const BASE_SCALE = 58;

        // Gist/URL Init
        let gistToken = localStorage.getItem('gist-token') || '';
        let gistId = localStorage.getItem('gist-id') || '';
        if (gistToken) document.getElementById('gistToken').value = gistToken;
        if (gistId) document.getElementById('gistId').value = gistId;

        // URL„Éë„É©„É°„Éº„Çø„Åã„ÇâGist ID„ÇíË™≠„ÅøËæº„ÇÄ
        window.addEventListener('load', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const urlGistId = urlParams.get('gist');
            if (urlGistId) {
                document.getElementById('gistId').value = urlGistId;
                gistId = urlGistId;
                // Ëá™ÂãïË™≠„ÅøËæº„Åø„Çí„Éà„É©„Ç§
                loadFromGist();
            }
        });

        function shareUrl() {
            const currentGistId = document.getElementById('gistId').value;
            if (!currentGistId) {
                alert('Gist ID„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇÂÖà„Å´‰øùÂ≠ò„Åæ„Åü„ÅØË™≠„ÅøËæº„Åø„Çí„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }
            const url = new URL(window.location.href);
            url.searchParams.set('gist', currentGistId);
            navigator.clipboard.writeText(url.toString()).then(() => {
                alert('ÂÖ±ÊúâÁî®URL„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ\n„Åì„ÅÆURL„ÇíÈñã„Åè„Å®IDÂÖ•Âäõ‰∏çË¶Å„ÅßË™≠„ÅøËæº„ÇÅ„Åæ„Åô„ÄÇ');
            });
        }

        // ==================== TAB SWITCHING ====================
        function switchTab(tabName) {
            const tabs = ['globalColor', 'fileLoad', 'save'];
            tabs.forEach(tab => {
                const btn = document.querySelector(`[onclick="switchTab('${tab}')"]`);
                const content = document.getElementById(tab + 'Tab');
                if (content && btn) {
                    if (tab === tabName) {
                        btn.classList.add('active');
                        content.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                        content.classList.remove('active');
                    }
                }
            });
        }

        function switchInfoTab(tabName) {
            const tabs = ['keyInfo', 'notes'];
            tabs.forEach(tab => {
                const btn = document.querySelector(`[onclick="switchInfoTab('${tab}')"]`);
                const content = document.getElementById(tab + 'Tab');
                if (tab === tabName) {
                    btn.classList.add('active');
                    content.classList.add('active');
                } else {
                    btn.classList.remove('active');
                    content.classList.remove('active');
                }
            });
        }

        function showCategory(category) {
            document.querySelectorAll('.keycode-quick').forEach(el => {
                el.classList.remove('visible');
                el.style.display = 'none';
            });
            document.querySelectorAll('.category-btn').forEach(el => el.classList.remove('active'));
            
            const categoryEl = document.getElementById(category + 'Keycodes');
            if (categoryEl) {
                categoryEl.classList.add('visible');
                categoryEl.style.display = (category === 'encoder') ? 'block' : 'grid';
            }
            event.target.classList.add('active');

            if (category === 'encoder') {
                if (selectedKey !== null && encoderKeys[selectedKey]) {
                    document.getElementById('encoderInputs').style.display = 'block';
                    updateEncoderInputs();
                } else {
                    document.getElementById('encoderInputs').style.display = 'none';
                }
            }
        }

        // ==================== LOGIC ====================
        function updateKeyColors() {
            const bg = document.getElementById('keyBgColor').value;
            const text = document.getElementById('keyTextColor').value;
            keyColors.bg = bg;
            keyColors.text = text;
            document.getElementById('keyBgColorText').value = bg;
            document.getElementById('keyTextColorText').value = text;
            renderKeyboard();
        }

        function updateKeyColorsFromText(type) {
            const val = document.getElementById(`key${type.charAt(0).toUpperCase() + type.slice(1)}ColorText`).value;
            document.getElementById(`key${type.charAt(0).toUpperCase() + type.slice(1)}Color`).value = val;
            updateKeyColors();
        }

        function resetKeyColors() {
            document.getElementById('keyBgColor').value = '#3a3a4a';
            document.getElementById('keyTextColor').value = '#ffffff';
            updateKeyColors();
        }

        function updateKeyboardScale(value) {
            keyboardScalePercent = parseInt(value);
            renderKeyboard();
        }

        function updateIndividualKeyColor() {
            if (selectedKey === null) return;
            const bg = document.getElementById('keyIndividualBg').value;
            const text = document.getElementById('keyIndividualText').value;
            individualKeyColors[selectedKey] = { bg, text };
            document.getElementById('keyIndividualBgText').value = bg;
            document.getElementById('keyIndividualTextText').value = text;
            renderKeyboard();
        }
        
        function updateIndividualKeyColorFromText(type) {
            if (selectedKey === null) return;
            const textId = type === 'bg' ? 'keyIndividualBgText' : 'keyIndividualTextText';
            const inputId = type === 'bg' ? 'keyIndividualBg' : 'keyIndividualText';
            const val = document.getElementById(textId).value;
            document.getElementById(inputId).value = val;
            updateIndividualKeyColor();
        }

        function resetIndividualKeyColor() {
            if (selectedKey === null) return;
            delete individualKeyColors[selectedKey];
            document.getElementById('keyIndividualBg').value = keyColors.bg;
            document.getElementById('keyIndividualText').value = keyColors.text;
            renderKeyboard();
        }

        function adjustColor(color, amount) {
            const num = parseInt(color.replace('#', ''), 16);
            const r = Math.max(0, Math.min(255, (num >> 16) + amount));
            const g = Math.max(0, Math.min(255, ((num >> 8) & 0x00FF) + amount));
            const b = Math.max(0, Math.min(255, (num & 0x0000FF) + amount));
            return `#${((r << 16) | (g << 8) | b).toString(16).padStart(6, '0')}`;
        }

        // Encoder
        function setAsEncoder() {
            if (selectedKey === null) { alert('„Ç≠„Éº„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
            if (!encoderKeys[selectedKey]) {
                encoderKeys[selectedKey] = { ccw: 'KC_VOLD', push: 'KC_MUTE', cw: 'KC_VOLU' };
            }
            selectedEncoderSide = 'push';
            renderKeyboard();
            document.getElementById('encoderInputs').style.display = 'block';
            updateEncoderInputs();
            updateKeyInfoDisplay();
            document.getElementById('keycodeInput').value = encoderKeys[selectedKey].push;
        }

        function removeEncoder() {
            if (selectedKey === null) return;
            if (encoderKeys[selectedKey]) {
                delete encoderKeys[selectedKey];
                selectedEncoderSide = null;
                document.getElementById('encoderInputs').style.display = 'none';
                document.getElementById('keycodeInput').value = layers[currentLayer]?.keys[selectedKey] || '';
                renderKeyboard();
                updateKeyInfoDisplay();
            }
        }

        function updateEncoderInputs() {
            if (selectedKey === null || !encoderKeys[selectedKey]) return;
            const enc = encoderKeys[selectedKey];
            document.getElementById('encoderCcwInput').value = enc.ccw;
            document.getElementById('encoderPushInput').value = enc.push;
            document.getElementById('encoderCwInput').value = enc.cw;
        }

        function updateEncoderKeycode(type, value) {
            if (selectedKey === null || !encoderKeys[selectedKey]) return;
            encoderKeys[selectedKey][type] = value;
            renderKeyboard();
            updateKeyInfoDisplay();
            if (selectedEncoderSide === type) {
                document.getElementById('keycodeInput').value = value;
            }
        }

        // Render & Select
        function renderKeyboard() {
            const container = document.getElementById('keyboardContainer');
            if (!layoutData || layoutData.length === 0) {
                container.innerHTML = '<div style="color: #888; text-align: center;">JSON„Éï„Ç°„Ç§„É´„ÇíË™≠„ÅøËæº„Çì„Åß„Åè„Å†„Åï„ÅÑ</div>';
                return;
            }
            container.innerHTML = '';
            
            let minX = Infinity, maxX = -Infinity, minY = Infinity, maxY = -Infinity;
            layoutData.forEach(key => {
                minX = Math.min(minX, key.x);
                maxX = Math.max(maxX, key.x + (key.w || 1));
                minY = Math.min(minY, key.y);
                maxY = Math.max(maxY, key.y + (key.h || 1));
            });

            const scaleMultiplier = keyboardScalePercent / 100;
            const currentScale = BASE_SCALE * scaleMultiplier;
            const width = (maxX - minX) * currentScale + 40;
            const height = (maxY - minY) * currentScale + 40;
            container.style.width = width + 'px';
            container.style.height = height + 'px';

            const currentLayerData = layers[currentLayer];

            layoutData.forEach(key => {
                const x = (key.x - minX) * currentScale + 20;
                const y = (key.y - minY) * currentScale + 20;
                const w = (key.w || 1) * currentScale - 4;
                const h = (key.h || 1) * currentScale - 4;
                const isEnc = !!encoderKeys[key.id];
                const isSelected = (selectedKey === key.id);
                
                // Color Logic
                let bg, text, border;
                if (individualKeyColors[key.id]) {
                    bg = individualKeyColors[key.id].bg;
                    text = individualKeyColors[key.id].text;
                } else {
                    bg = keyColors.bg;
                    text = keyColors.text;
                }
                const bgGradient = `linear-gradient(145deg, ${bg}, ${adjustColor(bg, -20)})`;

                if (isEnc) {
                    const enc = encoderKeys[key.id];
                    // Push (Center)
                    const pushEl = document.createElement('div');
                    pushEl.className = 'key encoder';
                    pushEl.innerHTML = `<div style="font-size:0.9em;">${formatKeycode(enc.push)}</div>`;
                    applyKeyStyle(pushEl, x, y, w, h, key, bgGradient, text, keyFontSize, keyFont);
                    if (isSelected && (selectedEncoderSide === 'push' || !selectedEncoderSide)) pushEl.classList.add('selected');
                    pushEl.onclick = (e) => { e.stopPropagation(); selectKey(key.id, 'push'); };
                    container.appendChild(pushEl);

                    // CCW (Left)
                    const ccwEl = document.createElement('div');
                    ccwEl.className = 'encoder-side-box';
                    if (isSelected) ccwEl.classList.add('visible');
                    ccwEl.innerHTML = `<div style="font-size:0.8em;">${formatKeycode(enc.ccw)}</div>`;
                    applyKeyStyle(ccwEl, x - w - 8, y, w, h, null, bgGradient, text, keyFontSize, keyFont); // No rotation for side boxes
                    if (isSelected && selectedEncoderSide === 'ccw') ccwEl.classList.add('selected');
                    ccwEl.onclick = (e) => { e.stopPropagation(); selectKey(key.id, 'ccw'); };
                    container.appendChild(ccwEl);

                    // CW (Right)
                    const cwEl = document.createElement('div');
                    cwEl.className = 'encoder-side-box';
                    if (isSelected) cwEl.classList.add('visible');
                    cwEl.innerHTML = `<div style="font-size:0.8em;">${formatKeycode(enc.cw)}</div>`;
                    applyKeyStyle(cwEl, x + w + 8, y, w, h, null, bgGradient, text, keyFontSize, keyFont);
                    if (isSelected && selectedEncoderSide === 'cw') cwEl.classList.add('selected');
                    cwEl.onclick = (e) => { e.stopPropagation(); selectKey(key.id, 'cw'); };
                    container.appendChild(cwEl);
                } else {
                    const keyEl = document.createElement('div');
                    keyEl.className = 'key';
                    const kc = currentLayerData?.keys[key.id] || 'KC_NO';
                    keyEl.textContent = formatKeycode(kc);
                    applyKeyStyle(keyEl, x, y, w, h, key, bgGradient, text, keyFontSize, keyFont);
                    if (isSelected) keyEl.classList.add('selected');
                    keyEl.onclick = (e) => { e.stopPropagation(); selectKey(key.id, null); };
                    container.appendChild(keyEl);
                }
            });
        }

        function applyKeyStyle(el, x, y, w, h, keyData, bg, text, fSize, fFamily) {
            el.style.left = x + 'px';
            el.style.top = y + 'px';
            el.style.width = w + 'px';
            el.style.height = h + 'px';
            el.style.fontSize = fSize + 'px';
            el.style.fontFamily = fFamily;
            el.style.background = bg;
            el.style.color = text;
            if (keyData && keyData.r) {
                // Rotation logic needs origin recalc relative to current scaling
                // Simplified for now assuming consistent layout
                el.style.transform = `rotate(${keyData.r}deg)`;
                // Origin calculation omitted for brevity, usually handled by layout JSON rx/ry
            }
        }

        function formatKeycode(kc) {
            if (!kc) return '-';
            if (kc === 'KC_TRNS' || kc === '_______') return '‚ñΩ';
            if (kc === 'KC_NO' || kc === 'XXXXXXX') return '‚úï';
            return kc.replace('KC_', '').substring(0, 8);
        }

        function selectKey(keyId, encoderPart) {
            selectedKey = keyId;
            if (encoderKeys[keyId]) {
                selectedEncoderSide = encoderPart || (selectedEncoderSide ? selectedEncoderSide : 'push');
            } else {
                selectedEncoderSide = null;
            }
            renderKeyboard();
            
            const currentLayerData = layers[currentLayer];
            let keycode = '';
            let info = `(Key ${keyId})`;

            if (encoderKeys[keyId]) {
                const side = selectedEncoderSide || 'push';
                keycode = encoderKeys[keyId][side];
                info += ` - ${side === 'ccw' ? 'Â∑¶ÂõûËª¢' : side === 'cw' ? 'Âè≥ÂõûËª¢' : '„Éó„ÉÉ„Ç∑„É•'}`;
                document.getElementById('encoderInputs').style.display = 'block';
                updateEncoderInputs();
            } else {
                keycode = currentLayerData?.keys[keyId] || '';
                document.getElementById('encoderInputs').style.display = 'none';
            }

            document.getElementById('selectedKeyId').textContent = info;
            document.getElementById('keycodeInput').value = keycode;
            document.getElementById('editorPanel').classList.add('visible');
            updateKeyInfoDisplay();

            // Init Color Inputs
            if (individualKeyColors[keyId]) {
                document.getElementById('keyIndividualBg').value = individualKeyColors[keyId].bg;
                document.getElementById('keyIndividualText').value = individualKeyColors[keyId].text;
            } else {
                document.getElementById('keyIndividualBg').value = keyColors.bg;
                document.getElementById('keyIndividualText').value = keyColors.text;
            }
        }

        function updateKeycode(value) {
            if (selectedKey === null || !layers[currentLayer]) return;
            if (encoderKeys[selectedKey] && selectedEncoderSide) {
                encoderKeys[selectedKey][selectedEncoderSide] = value;
                updateEncoderInputs();
            } else {
                layers[currentLayer].keys[selectedKey] = value;
            }
            renderKeyboard();
            updateKeyInfoDisplay();
        }

        function updateKeyInfoDisplay() {
            if (selectedKey === null) return;
            const keyData = layoutData.find(k => k.id === selectedKey);
            let html = `<strong>ID:</strong> ${selectedKey} <br> <strong>Pos:</strong> X=${keyData.x}, Y=${keyData.y}`;
            if (encoderKeys[selectedKey]) {
                const enc = encoderKeys[selectedKey];
                html += `<br><span style="color:#ff8800">Encoder:</span> CCW=${enc.ccw}, Push=${enc.push}, CW=${enc.cw}`;
            }
            document.getElementById('keyInfoDisplay').innerHTML = html;
        }

        // ==================== NOTES ====================
        function addNote(type) {
            notes[type].push({ id: nextNoteId[type]++, name: '', description: '' });
            renderNotes(type);
        }
        function deleteNote(type, id) {
            notes[type] = notes[type].filter(n => n.id !== id);
            renderNotes(type);
        }
        function updateNote(type, id, field, val) {
            const note = notes[type].find(n => n.id === id);
            if (note) note[field] = val;
        }
        function renderNotes(type) {
            const container = document.getElementById(type + 'Notes');
            container.innerHTML = '';
            notes[type].forEach(note => {
                const div = document.createElement('div');
                div.className = 'note-item';
                div.innerHTML = `
                    <div class="note-header">
                        <span style="font-size:0.8em; color:#888;">#${note.id}</span>
                        <div class="delete-note" onclick="deleteNote('${type}', ${note.id})">√ó</div>
                    </div>
                    <input type="text" placeholder="Name" value="${note.name}" oninput="updateNote('${type}', ${note.id}, 'name', this.value)">
                    <input type="text" placeholder="Description" value="${note.description}" oninput="updateNote('${type}', ${note.id}, 'description', this.value)">
                `;
                container.appendChild(div);
            });
        }

        // ==================== LAYERS ====================
        function renderLayerTabs() {
            const container = document.getElementById('layerTabs');
            container.innerHTML = '';
            layers.forEach((layer, index) => {
                const btn = document.createElement('button');
                btn.className = `layer-tab ${index === currentLayer ? 'active' : ''}`;
                btn.innerHTML = `<span>${layer.name}</span>`;
                if (layers.length > 1) {
                    const del = document.createElement('button');
                    del.className = 'delete-layer';
                    del.textContent = '√ó';
                    del.onclick = (e) => { e.stopPropagation(); deleteLayer(index); };
                    btn.appendChild(del);
                }
                btn.onclick = () => switchLayer(index);
                container.appendChild(btn);
            });
            const add = document.createElement('button');
            add.className = 'add-layer-btn';
            add.textContent = '+';
            add.onclick = addLayer;
            container.appendChild(add);
        }
        function switchLayer(idx) {
            currentLayer = idx;
            renderLayerTabs();
            renderKeyboard();
            document.getElementById('layerCount').textContent = layers.length;
            if (selectedKey !== null) selectKey(selectedKey, selectedEncoderSide);
        }
        function addLayer() {
            if (!layoutData) { alert('Load JSON first'); return; }
            if (layers.length >= MAX_LAYERS) return;
            const newLayer = { name: `L${layers.length}`, keys: {} };
            layoutData.forEach(k => newLayer.keys[k.id] = 'KC_TRNS');
            layers.push(newLayer);
            switchLayer(layers.length - 1);
        }
        function deleteLayer(idx) {
            if (layers.length <= 1) return;
            if (!confirm('Delete layer?')) return;
            layers.splice(idx, 1);
            if (currentLayer >= layers.length) currentLayer = layers.length - 1;
            switchLayer(currentLayer);
        }

        // ==================== FILE I/O (Simplified) ====================
        function loadKeyboardJson(e) {
            const f = e.target.files[0];
            if (!f) return;
            const r = new FileReader();
            r.onload = (ev) => {
                try {
                    const j = JSON.parse(ev.target.result);
                    const lName = Object.keys(j.layouts)[0];
                    layoutData = j.layouts[lName].layout.map((k, i) => ({
                        id: i, x: k.x||0, y: k.y||0, w: k.w||1, h: k.h||1, r: k.r||0
                    }));
                    if (layers.length === 0) {
                        layers = [{name:'Base', keys:{}}];
                        layoutData.forEach(k => layers[0].keys[k.id] = 'KC_NO');
                    }
                    renderLayerTabs();
                    renderKeyboard();
                    document.getElementById('editorPanel').classList.add('visible');
                    document.getElementById('layerCount').textContent = layers.length;
                } catch(err) { alert(err); }
            };
            r.readAsText(f);
        }
        
        // Gist Save/Load
        function saveGistToken() {
            localStorage.setItem('gist-token', document.getElementById('gistToken').value);
        }
        async function saveToGist() {
            const token = document.getElementById('gistToken').value;
            if (!token) { alert('Token required'); return; }
            const content = JSON.stringify({
                layoutData, layers, keyColors, individualKeyColors, encoderKeys, notes
            });
            const body = {
                description: "QMK Editor Data",
                public: false,
                files: { "keymap.json": { content } }
            };
            try {
                const id = document.getElementById('gistId').value;
                const url = id ? `https://api.github.com/gists/${id}` : 'https://api.github.com/gists';
                const method = id ? 'PATCH' : 'POST';
                const res = await fetch(url, {
                    method, headers: { Authorization: `token ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                if (!res.ok) throw new Error('Failed');
                const json = await res.json();
                document.getElementById('gistId').value = json.id;
                alert('Saved! ID: ' + json.id);
            } catch(e) { alert(e); }
        }
        async function loadFromGist() {
            const id = document.getElementById('gistId').value;
            if (!id) { alert('No ID'); return; }
            try {
                const res = await fetch(`https://api.github.com/gists/${id}`);
                if (!res.ok) throw new Error('Failed');
                const json = await res.json();
                const content = JSON.parse(json.files['keymap.json'].content);
                layoutData = content.layoutData;
                layers = content.layers;
                keyColors = content.keyColors || keyColors;
                individualKeyColors = content.individualKeyColors || {};
                encoderKeys = content.encoderKeys || {};
                notes = content.notes || notes;
                
                renderLayerTabs();
                renderKeyboard();
                document.getElementById('editorPanel').classList.add('visible');
                document.getElementById('layerCount').textContent = layers.length;
                renderNotes('tapDance'); renderNotes('combo'); renderNotes('macro');
            } catch(e) { alert(e); }
        }
        
        // Local Save/Load
        function saveToLocal() {
            const data = JSON.stringify({ layoutData, layers, keyColors, individualKeyColors, encoderKeys, notes });
            localStorage.setItem('qmk-data', data);
            alert('Saved to browser');
        }
        function loadFromLocal() {
            const data = JSON.parse(localStorage.getItem('qmk-data'));
            if (!data) return;
            layoutData = data.layoutData;
            layers = data.layers;
            keyColors = data.keyColors || keyColors;
            individualKeyColors = data.individualKeyColors || {};
            encoderKeys = data.encoderKeys || {};
            notes = data.notes || notes;
            renderLayerTabs(); renderKeyboard();
            document.getElementById('editorPanel').classList.add('visible');
            document.getElementById('layerCount').textContent = layers.length;
            renderNotes('tapDance'); renderNotes('combo'); renderNotes('macro');
        }

        document.querySelectorAll('.keycode-quick').forEach(c => {
            c.addEventListener('click', e => {
                if (e.target.classList.contains('keycode-btn')) {
                    document.getElementById('keycodeInput').value = e.target.dataset.kc;
                    updateKeycode(e.target.dataset.kc);
                }
            });
        });
    </script>
</body>
</html>
